<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Connexion OneDriveâ€¦</title>
<script>
    async function exchangeCodeForToken() {

        // ðŸ”¹ RÃ©cupÃ¨re le code renvoyÃ© par Microsoft
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");

        if (!code) {
            document.body.innerHTML = "Erreur : aucun code reÃ§u.";
            return;
        }

        // ðŸ”¹ ParamÃ¨tres OAuth2
        const clientId = "4c6a4fb0-1ce2-4ad8-a5a1-cb7a0b42b5db";
        const redirectUri = "https://boeglinteva-ai.github.io/DLC/onedrive-callback.html";

        // ðŸ”¹ Construction de la requÃªte pour obtenir lâ€™access_token
        const body =
            `client_id=${encodeURIComponent(clientId)}` +
            `&code=${encodeURIComponent(code)}` +
            `&grant_type=authorization_code` +
            `&redirect_uri=${encodeURIComponent(redirectUri)}` +
            `&scope=${encodeURIComponent("openid profile email offline_access Files.ReadWrite.All")}`;

        try {
            const response = await fetch("https://login.microsoftonline.com/common/oauth2/v2.0/token", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body
            });

            const data = await response.json();

            if (data.access_token) {
                // ðŸ”¹ On sauvegarde le token OneDrive
                localStorage.setItem("onedrive_token", data.access_token);

                document.body.innerHTML = "<h2>OK â€” Vous pouvez fermer cette fenÃªtre.</h2>";
            } else {
                document.body.innerHTML =
                    "Erreur Microsoft :<br><pre>" + JSON.stringify(data, null, 2) + "</pre>";
            }

        } catch (err) {
            document.body.innerHTML = "Erreur rÃ©seau : " + err;
        }
    }

    exchangeCodeForToken();
</script>
</head>
<body>
Connexionâ€¦
</body>
</html>
