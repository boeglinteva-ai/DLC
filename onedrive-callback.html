<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Padova DLC ‚Äì OneDrive callback</title>
</head>
<body>
  <p id="status">Traitement de la connexion OneDrive‚Ä¶</p>

  <!-- üî• OBLIGATOIRE : charger la config -->
  <script src="config.js"></script>

  <!-- üî• OBLIGATOIRE : le code PKCE pour g√©n√©rer/verifier le code_verifier -->
  <script src="oAuth-pkce.js"></script>

  <script>
    (async function () {
      const statusEl = document.getElementById("status");

      if (!window.ONEDRIVE_CONFIG) {
        statusEl.textContent = "Erreur : configuration OneDrive manquante.";
        return;
      }

      // R√©cup√®re le code d‚Äôautorisation
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      const error = params.get("error");

      if (error) {
        statusEl.textContent = "Erreur Microsoft : " + error;
        return;
      }

      if (!code) {
        statusEl.textContent = "Erreur : aucun code de connexion trouv√©.";
        return;
      }

      const verifier = sessionStorage.getItem("onedrive_pkce_verifier");
      if (!verifier) {
        statusEl.textContent =
          "Erreur : code_verifier PKCE introuvable (session expir√©e ?).";
        return;
      }

      try {
        const body = new URLSearchParams();
        body.append("client_id", ONEDRIVE_CONFIG.clientId);
        body.append("scope", ONEDRIVE_CONFIG.scopes);
        body.append("code", code);
        body.append("redirect_uri", ONEDRIVE_CONFIG.redirectUri);
        body.append("grant_type", "authorization_code");
        body.append("code_verifier", verifier);

        const resp = await fetch(
          "https://login.microsoftonline.com/common/oauth2/v2.0/token",
          {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body
          }
        );

        const data = await resp.json();

        if (data.error) {
          console.error("Token error:", data);
          statusEl.textContent =
            "Erreur Microsoft : " + (data.error_description || data.error);
          return;
        }

        // Sauvegarde du token dans le localStorage
        localStorage.setItem("onedrive_token", data.access_token);

        // Nettoyage
        sessionStorage.removeItem("onedrive_pkce_verifier");

        statusEl.textContent = "OK ‚Äî Vous pouvez fermer cette fen√™tre.";

        // Retour automatique vers l'app
        setTimeout(() => {
          window.location.href = "index.html";
        }, 1000);

      } catch (e) {
        console.error(e);
        statusEl.textContent = "Erreur r√©seau lors de la r√©cup√©ration du token.";
      }
    })();
  </script>
</body>
</html>